#!/bin/bash
##############################################################################
# pre-push hook for verify-release-readiness
#
# Purpose:
#   Automatically detects changed skills before pushes and ensures version
#   numbers have been updated. Blocks pushes if versions need updating.
#
# Installation:
#   For Git:
#     ln -sf ../../../../.claude/skills/verify-release-readiness/hooks/pre-push .git/hooks/pre-push
#
#   For Jujutsu (jj):
#     Works automatically when using `jj git push` (uses Git's hooks)
#
# Why pre-push is better than pre-commit:
#   - Works automatically for both Git and Jujutsu users
#   - Jujutsu users run `jj git push` which triggers Git's pre-push hook
#   - Single installation method for both VCS types
#   - Validates before publishing, not before committing (less intrusive)
#
##############################################################################

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get repo root
REPO_ROOT=$(pwd)
while [ ! -d "$REPO_ROOT/.git" ] && [ ! -d "$REPO_ROOT/.jj" ] && [ "$REPO_ROOT" != "/" ]; do
    REPO_ROOT=$(dirname "$REPO_ROOT")
done

DETECT_SCRIPT="$REPO_ROOT/.claude/skills/verify-release-readiness/scripts/detect-changes.sh"

# Check if detect script exists
if [ ! -f "$DETECT_SCRIPT" ]; then
    # Silently exit if script doesn't exist (not a skill-dev repo)
    exit 0
fi

# Detect VCS type for user guidance
if [ -d "$REPO_ROOT/.jj" ]; then
    VCS="jj git"
elif [ -d "$REPO_ROOT/.git" ]; then
    VCS="git"
else
    VCS="git"
fi

# Run detection script - comparing against main@origin for jj, origin/main for git
echo -e "${YELLOW}⏱  Checking for skill changes before push...${NC}"

# Capture output and exit code
set +e
OUTPUT=$(bash "$DETECT_SCRIPT" 2>&1)
EXIT_CODE=$?
set -e

# Exit code 0: changes detected
# Exit code 1: no changes
# Exit code 2: error

if [ $EXIT_CODE -eq 2 ]; then
    echo -e "${RED}✗ Error running skill change detection${NC}" >&2
    echo "$OUTPUT" >&2
    exit 0  # Don't block push on detection errors
fi

if [ $EXIT_CODE -eq 1 ]; then
    echo -e "${GREEN}✓ No skill changes detected${NC}"
    exit 0  # No skill changes, allow push
fi

# Parse JSON output to check for skills needing updates
NEEDS_UPDATE=$(echo "$OUTPUT" | jq -r '.changed_skills[] | select(.needs_update == true) | .name' 2>/dev/null)

if [ -z "$NEEDS_UPDATE" ]; then
    echo -e "${GREEN}✓ All changed skills have updated versions${NC}"
    exit 0  # All versions updated, allow push
fi

# Skills need version updates - block push
echo ""
echo -e "${RED}✗ PUSH BLOCKED: Skills with unchanged versions detected${NC}"
echo ""
echo -e "${YELLOW}The following skills have changes but haven't had their version numbers updated:${NC}"
echo ""

echo "$NEEDS_UPDATE" | while IFS= read -r skill; do
    CURRENT_VERSION=$(echo "$OUTPUT" | jq -r ".changed_skills[] | select(.name == \"$skill\") | .current_version")
    MAIN_VERSION=$(echo "$OUTPUT" | jq -r ".changed_skills[] | select(.name == \"$skill\") | .main_version")
    echo -e "  ${RED}⚠${NC}  ${YELLOW}$skill${NC}"
    echo -e "      Current version: $CURRENT_VERSION"
    echo -e "      Main version: $MAIN_VERSION"
    echo ""
done

echo -e "${YELLOW}Action required:${NC}"
echo ""
echo "  1. Update the 'version' field in SKILL.md frontmatter for each flagged skill"
echo "  2. Follow semantic versioning:"
echo "     - Patch (0.1.0 → 0.1.1): Bug fixes, minor changes"
echo "     - Minor (0.1.0 → 0.2.0): New features, backward compatible"
echo "     - Major (0.1.0 → 1.0.0): Breaking changes"
echo "  3. Commit the version changes: $VCS commit -m 'bump versions'"
echo "  4. Retry the push"
echo ""
echo "To bypass this check (not recommended):"
echo "  $VCS push --no-verify"
echo ""

exit 1  # Block push
